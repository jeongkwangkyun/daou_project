# daou_project

## 주요 테이블

- 회원 
  - 로그인 처리할때 필요한 id,pw 컬럼을 만들어 유저 자체 상태를 나타낼 수 있는 테이블을 만들었습니다.

- 적립금
  - 적립금 정보를 조회할 때 필요한 테이블을 만들고, 회원 아이디를 fk로 받았습니다. 적립금을 결제, 환불할때마다 +,- update 처리할 계획입니다.

- 포인트
  - 모든 포인트 정보가 있는 `point`테이블과 결제 포인트만 저장하는 `payment_point` 테이블로 분리시켰습니다. 결제 과정에서 잔여 포인트를 - 해주고 결제포인트에 insert하는 로직과, 환불 과정에서 포인트를 다시 잔여 포인트에 + 할 계획입니다.
  
- 쿠폰
  - 5%, 10%, 20%의 상황을 A,B,C로 분리하기위해서 type 컬럼을 만들어줬습니다. 또한, 결제시 하나의 쿠폰만 적용 가능하다고 상황을 가정했습니다. 

- 결제 
  - 상품과의 관계에서 N:M 관계이기 때문에 `product_payment_list`를 만들었습니다. 포인트가 복수 유형의 포인트가 사용될 수 있는 상황이 발생하여 `payment_point`테이블을 만들었습니다. `환불신청여부` 컬럼을 추가하여 환불 신청시 `refund` 테이블에 추가되도록 설계했습니다. 


# erd 다이어그램
![daou_기술세미나_v2](https://user-images.githubusercontent.com/59038419/145314373-adffb4cd-173d-485f-9b6f-cbfaf142d1c4.png)

# 결제 플로우차트
![결제 drawio](https://user-images.githubusercontent.com/59038419/145172428-7f9668b3-5aff-451b-8ba5-b357598f27a0.png)

# 환불 플로우차트
![환불 drawio](https://user-images.githubusercontent.com/59038419/145172492-1a871fb3-0201-455a-bc33-27fc4277034e.png)

# 시퀀스 다이어그램

![시퀀스 다이어그램 drawio](https://user-images.githubusercontent.com/59038419/145172539-97ae79a7-0859-49af-b4d9-418699d8aea6.png)

## UI 설계

### 메인화면
![01_메인화면](https://user-images.githubusercontent.com/59038419/145432056-1fcf8dcd-88e6-4a9a-8ecd-556bc3694dc9.png)

### 상품 주문 페이지
![02_상품 주문 페이지](https://user-images.githubusercontent.com/59038419/145432148-09fbd0f0-433e-42d7-b769-c7b38586253a.png)

### 직접 결제 방식 페이지
![03_직접결제방식](https://user-images.githubusercontent.com/59038419/145432254-5dd3c33d-6da8-405e-91dd-d24d0cd7f5f5.png)

### 자동 결제 방식 페이지
![04_자동결제방식](https://user-images.githubusercontent.com/59038419/145432313-53bd3796-9cee-45d9-9823-8670ba7f912f.png)

### 환불 신청 페이지
![05_환불신청 페이지](https://user-images.githubusercontent.com/59038419/145432388-b930ee97-272b-4173-bd7c-d3a1062e449a.png)

## 기능별 프로세스 진행

#### 주문-직접결제방식 프로세스
1. 상품 주문 페이지에서 개수와 체크박스를 이용해서 구매할 상품을 정해준 뒤, 직접결제방식을 선택합니다.

2. 해당 ID의 DB에서 현재 보유하고 있는 할인 쿠폰, 포인트, 적립금 정보를 가져와 화면에 보여줍니다.

3. 프론트 
	3-1 할인쿠폰이 중복 사용되지 않도록 구현합니다.
	3-2 포인트가 보유한 포인트보다 초과하지 않도록 구현합니다.
	3-3 적립금이 보유한 적립금보다 초과하지 않도록 구현합니다.
	3-4 총 가격 - (총 가격/할인 쿠폰 - 포인트 - 적립금)이 결제금액으로 자동으로 뜨게 구현합니다. ( 할인쿠폰이 적용되는 금액이 소수점일시 반올림처리)
	추가 신경쓸점 
		- 이상한 값이 들어온다면 alert로 알림 처리합니다.
		- 초과 값을 입력한다면 alert로 알림 처리합니다.
4. 백
	4-1 (Controller) 넘어온 값(ID, 할인쿠폰, 포인트, 적립금, 상품정보)의 유효값 검증을 합니다.
	4-2 (Service) Dao로 전달합니다.
	4-3 (Dao) DB로 전달합니다.
	4-4 (Database) 
		       쿠폰 테이블에 해당 쿠폰 사용처리를 합니다.
		       포인트 테이블에 포인트를 유효기간 순으로 잔여포인트에서 마이너스 처리를 해주고, 사용한만큼 결제 포인트 테이블에 insert처리를 해줍니다.  (잔여 포인트가 충분하지 않다면 다음 유효기간이 긴 포인트를 사용합니다.)
		       해당 적립금을 마이너스 처리를 해줍니다.
		       결제 테이블에 직접 결제한 금액 정보와 해당 결제 정보를 입력합니다.
5. DB -> Dao -> Service -> Controller -> 프론트로 돌아와 완료되었습니다. 메세지를 출력합니다.

#### 주문-자동결제방식 프로세스

1. 상품 주문 페이지에서 개수와 체크박스를 이용해서 구매할 상품을 정해준 뒤, 자동결제방식을 선택합니다.

2. 백 
	해당 ID의 DB에서 현재 보유하고 있는 할인 쿠폰, 포인트, 적립금 정보를 Service에서 가장 결제금액이 낮도록 로직을 구현해줍니다.
	1-1 (Controller) 넘어온 값(ID, 상품정보)에 대한 유효값 검증을 합니다.
	1-2 (Service)  Dao로 전달합니다. 
	1-3 (Dao) DB로 전달합니다.
	1-4 (Database) 해당 ID의 DB에서 현재 보유하고 있는 할인 쿠폰, 포인트, 적립금 정보를 가져옵니다.
	1-5 (Dao) Service로 return합니다.
	1-6 (Service) 가격순으로 할인쿠폰을 높은 순으로 적용합니다.
		     남은 결제금액보다 포인트가 많은 경우 유효기간이 짧은 순으로 적용합니다.
		     남은 결제금액보다 포인트가 적은 경우 모두 적용합니다.
		     남은 결제금액보다 적립금이 많을 시 결제 금액만큼 사용하고, 적을 시 모든 포인트를 사용합니다.
		     Controller에 결제 예정정보를 전달합니다.
	1-7 (Controller) View로 넘겨줍니다.

3. 프론트 
	결제 예정정보를 화면에 보여줍니다.

4. 결제하기 클릭시 결제 예정정보를 가지고 직접 결제방식의 백(4번 과정)을 똑같이 수행합니다.

#### 환불 신청 프로세스 (일마다 포인트 소멸여부 판별해주기)

1. DB에서 결제한 상품의 정보를 가져와 화면에 보여줍니다. (결제가 일주일이 지난다면 환불 신청이 불가능하게 처리를 해줍니다.)

2. 신청하기 버튼 클릭시 백단으로 이동

3. 백엔드
	3-1 (Controller) 넘어온 값(ID, 상품정보)에 대한 유효값 검증을 합니다.
	3-2 (Service) Dao 로 전달합니다.
	3-2 (Dao) DB로 전달합니다.
	3-3 (DB)  결제한 할인쿠폰을 반환해줍니다.
	            결제한 포인트의 소멸여부를 판별하여 반환여부를 결정합니다.
		결제한 적립금을 반환해줍니다.
		결제한 직접 결제금액을 반환해줍니다.
4. Dao -> Service -> Controller -> view 이동하여 환불 신청 완료를 화면에 표시합니다.

# 좋은 하루되세요.
# 감사합니다.
